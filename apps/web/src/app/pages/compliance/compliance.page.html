<div class="compliance-page">
	<!-- Header with judge picker + brief -->
	<app-bulk-compliance-header
		[judges]="judges()"
		[selectedJudgeIds]="selectedJudgeIds()"
		[brief]="brief()"
		[loading]="loadingJudges()"
		[evaluating]="isEvaluating()"
		(selectedJudgeIdsChange)="selectedJudgeIds.set($event)"
		(briefChange)="brief.set($event)"
	/>

	<div class="compliance-body">
		<!-- Summary strip -->
		@if (hasImages()) { @let s = summary();
		<div class="compliance-summary" aria-live="polite">
			<span class="compliance-summary__stat">
				<span class="compliance-summary__stat-value"
					>{{ s.total }}</span
				>
				image{{ s.total !== 1 ? 's' : '' }}
			</span>

			@if (s.passed > 0) {
			<span class="compliance-summary__stat">
				<span
					class="compliance-summary__stat-dot compliance-summary__stat-dot--pass"
				></span>
				<span class="compliance-summary__stat-value"
					>{{ s.passed }}</span
				>
				passed
			</span>
			} @if (s.warned > 0) {
			<span class="compliance-summary__stat">
				<span
					class="compliance-summary__stat-dot compliance-summary__stat-dot--warn"
				></span>
				<span class="compliance-summary__stat-value"
					>{{ s.warned }}</span
				>
				warnings
			</span>
			} @if (s.failed > 0) {
			<span class="compliance-summary__stat">
				<span
					class="compliance-summary__stat-dot compliance-summary__stat-dot--fail"
				></span>
				<span class="compliance-summary__stat-value"
					>{{ s.failed }}</span
				>
				failed
			</span>
			} @if (s.errors > 0) {
			<span class="compliance-summary__stat">
				<span
					class="compliance-summary__stat-value compliance-summary__stat-value--error"
					>{{ s.errors }}</span
				>
				error{{ s.errors !== 1 ? 's' : '' }}
			</span>
			} @if (s.avgScore !== null) {
			<span
				class="compliance-summary__stat compliance-summary__stat--avg"
			>
				Avg:
				<span class="compliance-summary__stat-value"
					>{{ s.avgScore }}</span
				>
			</span>
			}

			<!-- No judges warning -->
			@if (selectedJudgeIds().length === 0 && hasImages()) {
			<span class="compliance-summary__warning">
				<i class="pi pi-info-circle"></i>
				Select judges to start evaluation
			</span>
			}
		</div>
		}

		<!-- Image grid with drop zone -->
		<app-image-grid
			[images]="images()"
			(filesDropped)="onFilesDropped($event)"
			(urlClicked)="showUrlDialog.set(true)"
			(browseClicked)="showBrowseDialog.set(true)"
			(removeImage)="onRemoveImage($event)"
			(selectImage)="onSelectImage($event)"
			(retryImage)="onRetryImage($event)"
		/>
	</div>

	<!-- URL dialog -->
	<p-dialog
		header="Add Image URL"
		[(visible)]="showUrlDialog"
		[modal]="true"
		[style]="{ width: '480px' }"
	>
		<div class="url-dialog">
			<input
				pInputText
				[ngModel]="urlInput()"
				(ngModelChange)="urlInput.set($event)"
				placeholder="https://example.com/image.jpg"
				class="w-full"
				(keydown.enter)="onAddUrl()"
			/>
		</div>
		<ng-template pTemplate="footer">
			<p-button
				label="Cancel"
				[text]="true"
				(onClick)="showUrlDialog.set(false)"
			/>
			<p-button
				label="Add Image"
				icon="pi pi-plus"
				(onClick)="onAddUrl()"
				[disabled]="!urlInput().trim()"
			/>
		</ng-template>
	</p-dialog>

	<!-- Browse dialog -->
	<app-image-picker-dialog
		[visible]="showBrowseDialog()"
		[orgId]="orgId"
		(visibleChange)="showBrowseDialog.set($event)"
		(imageSelected)="onBrowseSelected($event)"
	/>

	<!-- Detail modal -->
	<app-evaluation-detail-modal
		[visible]="showDetailModal()"
		[image]="selectedImage()"
		[hasPrev]="hasPrevImage()"
		[hasNext]="hasNextImage()"
		(visibleChange)="showDetailModal.set($event)"
		(navigatePrev)="onNavigatePrev()"
		(navigateNext)="onNavigateNext()"
	/>
</div>

<p-toast />
