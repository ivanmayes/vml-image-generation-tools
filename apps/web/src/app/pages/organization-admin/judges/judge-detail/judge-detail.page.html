<div class="judge-detail-page">
	<div class="page-header mb-4">
		<button
			pButton
			icon="pi pi-arrow-left"
			label="Back to Judges"
			class="p-button-text"
			(click)="goBack()"
		></button>

		<h1>
			@if (isCreateMode()) { Create Judge } @else { Edit Judge: {{
			agent()?.name }} }
		</h1>
	</div>

	@if (loading()) {
	<div class="loading-container">
		<p-progressSpinner></p-progressSpinner>
	</div>
	} @else {
	<p-tabs value="0">
		<p-tablist>
			<p-tab value="0">Prompt Config</p-tab>
			<p-tab value="1">Documents</p-tab>
			<p-tab value="2">Test / Evaluate</p-tab>
		</p-tablist>

		<form [formGroup]="form">
			<p-tabpanels>
				<p-tabpanel value="0">
					<div class="form-container">
						<div class="field">
							<label for="name">Name *</label>
							<input
								id="name"
								pInputText
								formControlName="name"
								placeholder="Enter judge name"
								class="w-full"
							/>
							@if (form.get('name')?.invalid &&
							form.get('name')?.touched) {
							<small class="p-error">Name is required.</small>
							}
						</div>

						<div class="field">
							<label for="systemPrompt">System Prompt *</label>
							<textarea
								id="systemPrompt"
								pTextarea
								formControlName="systemPrompt"
								[autoResize]="true"
								[rows]="10"
								placeholder="Enter the system prompt for this judge..."
								class="w-full system-prompt-textarea"
							></textarea>
							@if (form.get('systemPrompt')?.invalid &&
							form.get('systemPrompt')?.touched) {
							<small class="p-error"
								>System prompt is required.</small
							>
							}
						</div>

						<div class="field">
							<label for="evaluationCategories"
								>Evaluation Categories</label
							>
							<textarea
								id="evaluationCategories"
								pTextarea
								formControlName="evaluationCategories"
								[autoResize]="true"
								[rows]="3"
								placeholder="e.g. composition, lighting, color accuracy"
								class="w-full"
							></textarea>
							<small class="helper-text"
								>Comma-separated categories for evaluation
								scoring</small
							>
						</div>

						<div class="field">
							<label for="templateId">Template ID</label>
							<input
								id="templateId"
								pInputText
								formControlName="templateId"
								placeholder="Optional template identifier"
								class="w-full"
							/>
						</div>

						<div class="field-row">
							<div class="field">
								<label for="optimizationWeight"
									>Optimization Weight</label
								>
								<p-inputNumber
									formControlName="optimizationWeight"
									[min]="0"
									[max]="100"
									[showButtons]="true"
									inputId="optimizationWeight"
								></p-inputNumber>
							</div>

							<div class="field">
								<label for="scoringWeight"
									>Scoring Weight</label
								>
								<p-inputNumber
									formControlName="scoringWeight"
									[min]="0"
									[max]="100"
									[showButtons]="true"
									inputId="scoringWeight"
								></p-inputNumber>
							</div>
						</div>

						<div class="form-actions">
							<button
								pButton
								label="Cancel"
								class="p-button-outlined"
								(click)="cancel()"
								type="button"
							></button>
							<button
								pButton
								[label]="saving() ? 'Saving...' : 'Save'"
								icon="pi pi-check"
								(click)="save()"
								[disabled]="saving() || form.invalid"
								[loading]="saving()"
								type="button"
							></button>
						</div>
					</div>
				</p-tabpanel>

				<p-tabpanel value="1">
					<div class="form-container">
						<h3>RAG Configuration</h3>

						<div class="field-row">
							<div class="field">
								<label for="ragTopK">Top K Results</label>
								<p-inputNumber
									formControlName="ragTopK"
									[min]="1"
									[max]="20"
									[showButtons]="true"
									inputId="ragTopK"
								></p-inputNumber>
								<small class="helper-text"
									>Number of similar documents to retrieve
									(1-20)</small
								>
							</div>

							<div class="field">
								<label for="ragSimilarityThreshold"
									>Similarity Threshold</label
								>
								<p-inputNumber
									formControlName="ragSimilarityThreshold"
									[min]="0"
									[max]="1"
									[step]="0.05"
									[minFractionDigits]="2"
									[maxFractionDigits]="2"
									[showButtons]="true"
									inputId="ragSimilarityThreshold"
								></p-inputNumber>
								<small class="helper-text"
									>Minimum similarity score (0-1)</small
								>
							</div>
						</div>

						<p-divider></p-divider>

						<h3>Documents</h3>

						@if (isCreateMode()) {
						<p-message
							severity="info"
							text="Save the judge first to manage documents."
						></p-message>
						} @else {
						<div class="mb-3">
							<p-fileUpload
								mode="basic"
								[auto]="true"
								[customUpload]="true"
								(uploadHandler)="onUploadDocument($event)"
								chooseLabel="Upload Document"
								accept=".pdf,.txt,.doc,.docx"
								[maxFileSize]="10000000"
								[disabled]="uploadingDocument()"
							></p-fileUpload>
						</div>

						@if (loadingDocuments()) {
						<p-progressSpinner
							[style]="{ width: '40px', height: '40px' }"
						></p-progressSpinner>
						} @else if (documents().length > 0) {
						<p-table
							[value]="documents()"
							styleClass="p-datatable-sm"
						>
							<ng-template pTemplate="header">
								<tr>
									<th>Filename</th>
									<th>Type</th>
									<th>Chunks</th>
									<th>Uploaded</th>
									<th style="width: 80px">Actions</th>
								</tr>
							</ng-template>
							<ng-template pTemplate="body" let-doc>
								<tr>
									<td>{{ doc.filename }}</td>
									<td>{{ doc.mimeType }}</td>
									<td>{{ doc.chunkCount }}</td>
									<td>{{ formatDate(doc.createdAt) }}</td>
									<td>
										<button
											pButton
											icon="pi pi-trash"
											class="p-button-rounded p-button-text p-button-sm p-button-danger"
											pTooltip="Delete Document"
											(click)="deleteDocument(doc)"
										></button>
									</td>
								</tr>
							</ng-template>
							<ng-template pTemplate="emptymessage">
								<tr>
									<td colspan="5" class="text-center">
										No documents uploaded yet
									</td>
								</tr>
							</ng-template>
						</p-table>
						} @else {
						<p class="text-muted">
							No documents uploaded yet. Upload a PDF or text file
							to provide context for this judge.
						</p>
						} }
					</div>
				</p-tabpanel>

				<p-tabpanel value="2">
					<div class="form-container">
						@if (isCreateMode()) {
						<p-message
							severity="info"
							text="Save the judge first to run evaluations."
						></p-message>
						} @else {
						<div class="test-form">
							<div class="field">
								<label for="testBrief">Brief *</label>
								<textarea
									id="testBrief"
									pTextarea
									[(ngModel)]="testBrief"
									[ngModelOptions]="{ standalone: true }"
									[rows]="4"
									placeholder="Enter the image brief..."
									class="w-full"
								></textarea>
							</div>

							<div class="field">
								<label for="testImageUrl">Image URL *</label>
								<input
									id="testImageUrl"
									pInputText
									[(ngModel)]="testImageUrl"
									[ngModelOptions]="{ standalone: true }"
									placeholder="https://..."
									class="w-full"
								/>
							</div>

							<div class="field">
								<button
									pButton
									label="Run Evaluation"
									icon="pi pi-play"
									(click)="runEvaluation()"
									[disabled]="evaluating() || !testBrief || !testImageUrl"
									[loading]="evaluating()"
									type="button"
								></button>
							</div>
						</div>

						@if (evaluationResult(); as result) {
						<p-divider></p-divider>

						<div class="results-container">
							<!-- Score Display -->
							<div class="score-display">
								<span class="score-value"
									>{{ result.score }}</span
								>
								<p-tag
									[value]="result.score >= 80 ? 'Good' : result.score >= 60 ? 'Fair' : 'Poor'"
									[severity]="getScoreSeverity(result.score)"
								></p-tag>
							</div>

							<!-- Top Issue -->
							@if (result.topIssue) {
							<div class="top-issue-card">
								<div class="top-issue-header">
									<strong>Top Issue</strong>
									<p-tag
										[value]="result.topIssue.severity"
										[severity]="getSeverityColor(result.topIssue.severity)"
									></p-tag>
								</div>
								<p class="top-issue-problem">
									{{ result.topIssue.problem }}
								</p>
								<p class="top-issue-fix">
									<strong>Fix:</strong> {{ result.topIssue.fix
									}}
								</p>
							</div>
							}

							<!-- Category Scores -->
							@if (getCategoryScoreEntries().length > 0) {
							<div class="section">
								<h4>Category Scores</h4>
								@for (entry of getCategoryScoreEntries(); track
								entry[0]) {
								<div class="category-score-item">
									<span class="category-label"
										>{{ entry[0] }}</span
									>
									<div class="category-bar">
										<p-progressBar
											[value]="entry[1]"
											[showValue]="true"
										></p-progressBar>
									</div>
								</div>
								}
							</div>
							}

							<!-- What Worked -->
							@if (result.whatWorked && result.whatWorked.length >
							0) {
							<div class="section">
								<h4>What Worked</h4>
								<ul class="what-worked-list">
									@for (item of result.whatWorked; track item)
									{
									<li>{{ item }}</li>
									}
								</ul>
							</div>
							}

							<!-- Checklist -->
							@if (getChecklistEntries().length > 0) {
							<div class="section">
								<h4>Checklist</h4>
								@for (entry of getChecklistEntries(); track
								entry[0]) {
								<div class="checklist-item">
									@if (entry[1].passed) {
									<i
										class="pi pi-check-circle"
										style="color: var(--p-green-500)"
									></i>
									} @else {
									<i
										class="pi pi-times-circle"
										style="color: var(--p-red-500)"
									></i>
									}
									<span class="checklist-label"
										>{{ entry[0] }}</span
									>
									@if (entry[1].note) {
									<span class="checklist-note"
										>{{ entry[1].note }}</span
									>
									}
								</div>
								}
							</div>
							}

							<!-- Feedback -->
							@if (result.feedback) {
							<div class="section">
								<h4>Feedback</h4>
								<div class="feedback-block">
									{{ result.feedback }}
								</div>
							</div>
							}
						</div>
						} }
					</div>
				</p-tabpanel>
			</p-tabpanels>
		</form>
	</p-tabs>
	}
</div>

<p-toast></p-toast>
