<div class="generation-detail-page">
	<!-- Loading skeleton -->
	@if (loading()) {
	<div class="p-4">
		<p-skeleton width="200px" height="2rem" class="mb-3" />
		<p-skeleton width="100%" height="4rem" class="mb-3" />
		<p-skeleton width="100%" height="300px" />
	</div>
	} @else if (request(); as req) {
	<!-- Header -->
	<p-toolbar>
		<div class="p-toolbar-group-start flex align-items-center gap-3">
			<p-button
				icon="pi pi-arrow-left"
				[text]="true"
				(onClick)="onBack()"
			/>
			<h2 class="m-0">Generation Request</h2>
			<p-tag
				[value]="req.status"
				[severity]="getStatusSeverity(req.status)"
			/>
		</div>
		<div class="p-toolbar-group-end flex align-items-center gap-2">
			@if (sseConnected()) {
			<p-tag value="Live" severity="success" [rounded]="true" />
			}
			<span class="text-sm text-color-secondary">
				Iteration {{ req.currentIteration }} / {{ req.maxIterations }}
			</span>
			@if (isActive()) {
			<p-progressSpinner
				[style]="{ width: '24px', height: '24px' }"
				strokeWidth="4"
			/>
			}
		</div>
	</p-toolbar>

	<div class="p-4">
		<!-- Brief -->
		<div class="surface-card border-round p-4 mb-4">
			<h3 class="mt-0 mb-2">Brief</h3>
			<p class="m-0 line-height-3">{{ req.brief }}</p>
			@if (req.initialPrompt) {
			<div class="mt-3">
				<span class="text-sm font-semibold text-color-secondary"
					>Initial Prompt:</span
				>
				<p class="m-0 mt-1 text-sm font-mono line-height-3">
					{{ req.initialPrompt }}
				</p>
			</div>
			}
		</div>

		<!-- Score summary -->
		@if (latestScore() !== null) {
		<div class="surface-card border-round p-4 mb-4">
			<div class="flex align-items-center gap-4">
				<p-knob
					[ngModel]="latestScore()!"
					[readonly]="true"
					[size]="100"
					[strokeWidth]="8"
					valueTemplate="{value}%"
				/>
				<div>
					<h3 class="mt-0 mb-1">Latest Score</h3>
					<p class="text-color-secondary m-0">
						Threshold: {{ req.threshold }}%
					</p>
				</div>
			</div>
		</div>
		}

		<!-- Iteration Timeline -->
		@if (iterations().length > 0) {
		<div class="iteration-timeline mb-4">
			<h3 class="mt-0 mb-3">Iteration Timeline</h3>
			@for (iteration of iterations(); track iteration.iterationNumber;
			let last = $last) {
			<div class="timeline-entry mb-3">
				<app-round-card
					[iteration]="iteration"
					[images]="images()"
					[isLatest]="last"
				/>
			</div>
			}
			<div #timelineEnd></div>
		</div>
		} @else if (isActive()) {
		<div class="surface-card border-round p-4 mb-4">
			<div class="flex align-items-center gap-3">
				<p-progressSpinner
					[style]="{ width: '32px', height: '32px' }"
					strokeWidth="4"
				/>
				<span class="text-color-secondary">
					Generation in progress... Waiting for first iteration.
				</span>
			</div>
		</div>
		}

		<!-- Completion Banner -->
		@if (isTerminal()) {
		<div class="mb-4">
			<app-completion-banner
				[status]="req.status"
				[completionReason]="req.completionReason"
				[finalScore]="latestScore() ?? undefined"
				[threshold]="req.threshold"
			/>
		</div>
		}

		<!-- Continuation Editor -->
		@if (canContinue()) {
		<div class="mb-4">
			<app-continuation-editor
				[lastPrompt]="lastPrompt()"
				[submitting]="continuing()"
				(continueRequest)="onContinue($event)"
			/>
		</div>
		}

		<!-- Error Message -->
		@if (req.errorMessage) {
		<div class="mb-4">
			<p-message severity="error"> {{ req.errorMessage }} </p-message>
		</div>
		}
	</div>
	}
</div>
